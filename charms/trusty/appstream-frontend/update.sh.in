#!/bin/sh

set -e

BASE_DIR=${HOME}

LOG_BASE_DIR=${BASE_DIR}/logs

# Start logging
logdir="${LOG_BASE_DIR}/`date "+%Y/%m"`"
mkdir -p ${logdir}
NOW=`date "+%d"`
LOGFILE="${logdir}/${NOW}.log"
exec >> "${LOGFILE}" 2>&1

find ${logdir} -type f -not -path ${LOGFILE} -not -name \*.gz -exec gzip -9 {} \;

rsync -aqzP --delete --delete-after @RSYNC_HOST@::www /srv/appstream
rsync -aqzP --delete --delete-after @RSYNC_HOST@::logs /srv/logs

# finish logging
exec > /dev/null 2>&1
